name: HCC KHK Simulation

on:
  workflow_dispatch:
    inputs:
      khk_level:
        description: 'KHK expression level (11-20)'
        required: true
        default: '17.0'
        type: string
      simulation_time:
        description: 'Simulation time (minutes)'
        required: true
        default: '360'
        type: string
      patient_id:
        description: 'Patient ID'
        required: false
        default: 'test'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libxml2-dev zlib1g-dev
      
      - name: Verify custom files exist
        run: |
          echo "=== Checking custom modules ==="
          ls -la custom_modules/
          if [ ! -f custom_modules/custom.cpp ]; then
            echo "ERROR: custom.cpp not found!"
            exit 1
          fi
          if [ ! -f custom_modules/custom.h ]; then
            echo "ERROR: custom.h not found!"
            exit 1
          fi
          echo "âœ“ Custom files verified"
      
      - name: Update config with parameters
        run: |
          sed -i "s/<KHK_expression.*<\/KHK_expression>/<KHK_expression type=\"double\" units=\"dimensionless\">${{ github.event.inputs.khk_level }}<\/KHK_expression>/" config/PhysiCell_settings.xml
          sed -i "s/<max_time.*<\/max_time>/<max_time units=\"min\">${{ github.event.inputs.simulation_time }}<\/max_time>/" config/PhysiCell_settings.xml
          echo "=== Updated Configuration ==="
          cat config/PhysiCell_settings.xml | grep -A2 "user_parameters"
      
      - name: Compile PhysiCell
        run: |
          echo "=== Cleaning previous build (safe) ==="
          make clean
          
          echo ""
          echo "=== Compiling PhysiCell ==="
          make
          
          echo ""
          echo "=== Checking for executable ==="
          ls -lh | grep -E "(project|myproj|main)" || ls -lh
      
      - name: Run simulation
        run: |
          # Find the executable
          if [ -f ./project ]; then
            EXEC=./project
          elif [ -f ./myproj ]; then
            EXEC=./myproj  
          elif [ -f ./main ]; then
            EXEC=./main
          else
            echo "ERROR: No executable found!"
            echo "Contents of directory:"
            ls -la
            exit 1
          fi
          
          echo "Running: $EXEC"
          $EXEC
      
      - name: Verify output generated
        run: |
          if [ ! -d output ]; then
            echo "ERROR: Output directory not created!"
            exit 1
          fi
          
          echo "=== Simulation output ==="
          ls -lh output/
          
          FILE_COUNT=$(ls output/*.xml 2>/dev/null | wc -l)
          echo ""
          echo "Generated $FILE_COUNT XML output files"
          
          SVG_COUNT=$(ls output/*.svg 2>/dev/null | wc -l)
          echo "Generated $SVG_COUNT SVG visualization files"
      
      - name: Create summary
        run: |
          echo "# HCC KHK Simulation Results" > summary.md
          echo "" >> summary.md
          echo "**Patient ID:** ${{ github.event.inputs.patient_id }}" >> summary.md
          echo "**KHK Expression Level:** ${{ github.event.inputs.khk_level }}" >> summary.md
          echo "**Simulation Duration:** ${{ github.event.inputs.simulation_time }} minutes" >> summary.md
          echo "" >> summary.md
          echo "---" >> summary.md
          echo "" >> summary.md
          echo "## Output Files Generated" >> summary.md
          echo "" >> summary.md
          echo "\`\`\`" >> summary.md
          ls -lh output/ >> summary.md
          echo "\`\`\`" >> summary.md
          echo "" >> summary.md
          echo "## Quick Stats" >> summary.md
          XML_COUNT=$(ls output/*.xml 2>/dev/null | wc -l)
          SVG_COUNT=$(ls output/*.svg 2>/dev/null | wc -l)
          echo "- XML files: $XML_COUNT" >> summary.md
          echo "- SVG files: $SVG_COUNT" >> summary.md
          echo "" >> summary.md
          echo "## How to View Results" >> summary.md
          echo "1. Download and unzip this artifact" >> summary.md
          echo "2. Open any \`snapshot*.svg\` file in a web browser to see tumor visualization" >> summary.md
          echo "3. Final snapshot: \`snapshot$(printf '%08d' $((XML_COUNT - 1))).svg\`" >> summary.md
      
      - name: Upload simulation results
        uses: actions/upload-artifact@v4
        with:
          name: simulation-khk${{ github.event.inputs.khk_level }}-${{ github.event.inputs.patient_id }}
          path: |
            output/
            summary.md
          retention-days: 30
