name: HCC HBV Recurrence Simulation

on:
  workflow_dispatch:
    inputs:
      simulation_days:
        description: 'Days to simulate'
        required: true
        default: '3'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-pip
          pip3 install pandas numpy matplotlib seaborn
      
      - name: Setup PhysiCell
        run: |
          make heterogeneity-sample
          make -j$(nproc)
      
      - name: Test default run (minimal modification)
        run: |
          echo "=== Testing default heterogeneity sample ==="
          
          # Just change max_time, nothing else
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          
          tree = ET.parse("config/PhysiCell_settings.xml")
          root = tree.getroot()
          
          # Set to 1 day
          max_time = root.find(".//max_time")
          if max_time is not None:
              max_time.text = "1440"
          
          # Disable SVG
          svg_enable = root.find(".//SVG/enable")
          if svg_enable is not None:
              svg_enable.text = "false"
          
          # Set output every 12 hours
          full_interval = root.find(".//full_data/interval")
          if full_interval is not None:
              full_interval.text = "720"
          
          tree.write("config/PhysiCell_settings.xml")
          print("✓ Minimal config updated")
          EOF
          
          echo "=== Config check ==="
          grep -E "max_time|tumor_radius|number_of_cells" config/PhysiCell_settings.xml | head -5
          
          echo ""
          echo "=== Running simulation ==="
          timeout 120s ./heterogeneity > simulation.log 2>&1 &
          SIM_PID=$!
          
          # Monitor
          for i in {1..24}; do
            sleep 5
            
            if ! kill -0 $SIM_PID 2>/dev/null; then
              echo "Simulation finished at $((i*5))s"
              break
            fi
            
            if [ -d "output" ]; then
              XML_COUNT=$(ls output/output*.xml 2>/dev/null | wc -l)
              echo "[$i] Running... ($XML_COUNT outputs)"
            fi
          done
          
          wait $SIM_PID || echo "Exit code: $?"
          
          echo ""
          echo "=== Output directory ==="
          if [ -d "output" ]; then
            ls -lh output/ | head -20
          else
            echo "ERROR: No output directory created!"
          fi
          
          echo ""
          echo "=== Simulation log ==="
          cat simulation.log
      
      - name: Analyze what happened
        run: |
          python3 << 'EOF'
          import os
          import xml.etree.ElementTree as ET
          
          print("\n" + "="*70)
          print("DIAGNOSTIC ANALYSIS")
          print("="*70)
          
          # Check if output directory exists
          if not os.path.exists("output"):
              print("\n❌ PROBLEM: No 'output' directory created")
              print("   This means PhysiCell failed before writing any data.")
              
              # Check log for errors
              if os.path.exists("simulation.log"):
                  with open("simulation.log") as f:
                      log = f.read()
                  
                  # Look for common errors
                  if "error" in log.lower():
                      print("\n   Errors found in log:")
                      for line in log.split("\n"):
                          if "error" in line.lower():
                              print(f"     {line}")
                  
                  if "exception" in log.lower():
                      print("\n   Exceptions found:")
                      for line in log.split("\n"):
                          if "exception" in line.lower():
                              print(f"     {line}")
                  
                  if "segmentation fault" in log.lower() or "segfault" in log.lower():
                      print("\n   ⚠️ SEGMENTATION FAULT detected - memory issue")
                  
                  if len(log) < 100:
                      print(f"\n   ⚠️ Log is very short ({len(log)} chars) - program may have crashed immediately")
              
              exit(1)
          
          # Check XML files
          xml_files = [f for f in os.listdir("output") if f.endswith(".xml") and f.startswith("output")]
          
          if len(xml_files) == 0:
              print("\n❌ PROBLEM: Output directory exists but no XML files")
              print("   PhysiCell started but didn't save any timepoints.")
              exit(1)
          
          print(f"\n✅ SUCCESS: Found {len(xml_files)} output files")
          
          # Check cell counts
          for xml_file in xml_files[:5]:
              tree = ET.parse(f"output/{xml_file}")
              cell_count = len(tree.findall(".//cell"))
              print(f"   {xml_file}: {cell_count} cells")
          EOF
      
      - name: If successful, run HBV simulation
        if: success()
        run: |
          echo "=== Default run worked! Now adding HBV parameters ==="
          
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import numpy as np
          
          # Parse config
          tree = ET.parse("config/PhysiCell_settings.xml")
          root = tree.getroot()
          
          # Set simulation time
          sim_days = int("${{ github.event.inputs.simulation_days }}")
          max_time = root.find(".//max_time")
          if max_time is not None:
              max_time.text = str(sim_days * 1440)
          
          # Output every day
          full_interval = root.find(".//full_data/interval")
          if full_interval is not None:
              full_interval.text = "1440"
          
          # Add HBV parameters to user_parameters
          user_params = root.find(".//user_parameters")
          if user_params is not None:
              # Add HBV parameters
              def add_param(name, value, ptype="double"):
                  elem = ET.SubElement(user_params, name)
                  elem.text = str(value)
                  elem.set("type", ptype)
                  elem.set("units", "dimensionless")
              
              add_param("HBV_DNA_log", 5.0)
              add_param("cirrhosis_grade", 2, "int")
              add_param("inflammation_level", 0.7)
          
          tree.write("config/PhysiCell_settings.xml")
          print("✓ HBV parameters added")
          EOF
          
          # Clean output
          rm -rf output
          mkdir output
          
          # Run again
          echo "Running with HBV parameters..."
          ./heterogeneity
          
          # Check output
          if [ -d "output" ]; then
            XML_COUNT=$(ls output/output*.xml 2>/dev/null | wc -l)
            echo "✓ Generated $XML_COUNT output files with HBV parameters"
            
            # Quick analysis
            python3 << 'PYEOF'
          import os
          import xml.etree.ElementTree as ET
          
          xml_files = sorted([f for f in os.listdir("output") if f.startswith("output")])
          
          if len(xml_files) >= 2:
              tree0 = ET.parse(f"output/{xml_files[0]}")
              tree1 = ET.parse(f"output/{xml_files[-1]}")
              
              cells0 = len(tree0.findall(".//cell"))
              cells1 = len(tree1.findall(".//cell"))
              
              print(f"\nResults:")
              print(f"  Initial: {cells0} cells")
              print(f"  Final:   {cells1} cells")
              print(f"  Change:  {cells1 - cells0} ({100*(cells1-cells0)/cells0:.1f}%)")
          PYEOF
          fi
      
      - name: Upload all logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs
          path: |
            simulation.log
            output/
            config/PhysiCell_settings.xml
          retention-days: 7
      
      - name: Summary
        if: always()
        run: |
          echo "## Debug Summary" >> $GITHUB_STEP_SUMMARY
          
          if [ -f simulation.log ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Simulation Log:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat simulation.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d output ]; then
            XML_COUNT=$(ls output/*.xml 2>/dev/null | wc -l)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Output files generated:** $XML_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** ❌ No output directory" >> $GITHUB_STEP_SUMMARY
          fi
