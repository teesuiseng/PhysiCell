name: HCC HBV Recurrence Simulation

on:
  workflow_dispatch:
    inputs:
      patient_cohort:
        description: 'Patient cohort to simulate'
        required: true
        type: choice
        options:
          - 'high_risk'
          - 'low_risk'
          - 'hbv_negative'
          - 'single_patient'
        default: 'single_patient'  # Changed to single for faster testing
      
      hbv_viral_load:
        description: 'HBV DNA copies/mL (log10 scale, 0-8)'
        required: false
        default: '5.0'
        type: string
      
      cirrhosis_degree:
        description: 'Cirrhosis degree (0=none, 1=mild, 2=moderate, 3=severe)'
        required: false
        default: '2'
        type: string
      
      simulation_days:
        description: 'Simulation duration (days)'
        required: true
        default: '30'  # Reduced for faster testing
        type: string
      
      output_interval:
        description: 'Data sampling interval (hours)'
        required: true
        default: '24'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libxml2-dev zlib1g-dev python3-pip
          pip3 install pandas numpy matplotlib seaborn scipy
      
      - name: Compile PhysiCell  # MOVED BEFORE SIMULATION
        run: |
          make reset
          make heterogeneity-sample
          make -j2
          echo "=== Compilation complete ==="
          ls -lh heterogeneity
          echo "=== Verify executable ==="
          file heterogeneity
          ./heterogeneity --version || echo "Version check skipped"
      
      - name: Backup original config
        run: |
          cp config/PhysiCell_settings.xml config/PhysiCell_settings_original.xml
      
      - name: Setup patient cohort
        run: |
          python3 << 'EOF'
          import json
          
          cohort = "${{ github.event.inputs.patient_cohort }}"
          
          cohorts = {
              "high_risk": {
                  "hbv_dna": [1e6, 1e7],  # Reduced to 2 for faster testing
                  "hbsag": 1,
                  "hbeag": 1,
                  "cirrhosis": [2, 3],
                  "afp": [400, 800],
                  "tumor_size": [5, 7],
                  "description": "HBV+ high viral load, active replication"
              },
              "low_risk": {
                  "hbv_dna": [0, 1e3],
                  "hbsag": 1,
                  "hbeag": 0,
                  "cirrhosis": [0, 1],
                  "afp": [20, 100],
                  "tumor_size": [2, 4],
                  "description": "HBV+ low viral load, controlled"
              },
              "hbv_negative": {
                  "hbv_dna": [0],
                  "hbsag": 0,
                  "hbeag": 0,
                  "cirrhosis": [0, 1],
                  "afp": [15, 60],
                  "tumor_size": [3, 5],
                  "description": "HBV- control group"
              },
              "single_patient": {
                  "hbv_dna": [10 ** float("${{ github.event.inputs.hbv_viral_load }}")],
                  "hbsag": 1,
                  "hbeag": 1 if float("${{ github.event.inputs.hbv_viral_load }}") > 4 else 0,
                  "cirrhosis": [int("${{ github.event.inputs.cirrhosis_degree }}")],
                  "afp": [200],
                  "tumor_size": [5],
                  "description": "Single patient test"
              }
          }
          
          with open("cohort_config.json", "w") as f:
              json.dump(cohorts[cohort], f, indent=2)
          
          print(f"=== Cohort: {cohort} ===")
          print(cohorts[cohort]["description"])
          EOF
          
          cat cohort_config.json
      
      - name: Generate simulation configs
        run: |
          python3 << 'EOF'
          import json
          import xml.etree.ElementTree as ET
          from itertools import product
          import os
          
          # Load cohort
          with open("cohort_config.json") as f:
              cohort = json.load(f)
          
          # Generate parameter combinations
          params = []
          for i, (vl, cirrh, afp, size) in enumerate(product(
              cohort["hbv_dna"][:2],  # Max 2 viral loads
              cohort["cirrhosis"][:2],
              cohort["afp"][:2],
              cohort["tumor_size"][:2]
          )):
              params.append({
                  "sim_id": i,
                  "hbv_dna": vl,
                  "hbsag": cohort["hbsag"],
                  "hbeag": cohort["hbeag"],
                  "cirrhosis": cirrh,
                  "afp": afp,
                  "tumor_size": size,
                  # Derived parameters
                  "inflammation_level": min(vl / 1e7, 1.0) if vl > 0 else 0,
                  "immune_suppression": 0.2 + (cirrh * 0.2),
                  "proliferation_rate": 0.00072 * (1 + afp/1000),
                  "initial_cells": int(size ** 3 * 10)
              })
          
          with open("simulation_params.json", "w") as f:
              json.dump(params, f, indent=2)
          
          print(f"Generated {len(params)} simulation configurations")
          EOF
      
      - name: Run simulation batch
        run: |
          mkdir -p results
          
          python3 << 'EOF'
          import json
          import subprocess
          import os
          import shutil
          import xml.etree.ElementTree as ET
          
          with open("simulation_params.json") as f:
              params_list = json.load(f)
          
          results = []
          
          for params in params_list:
              sim_id = params["sim_id"]
              print(f"\n{'='*60}")
              print(f"Simulation {sim_id + 1}/{len(params_list)}")
              print(f"{'='*60}")
              print(f"HBV DNA: {params['hbv_dna']:.2e} copies/mL")
              print(f"Cirrhosis: Grade {params['cirrhosis']}")
              print(f"AFP: {params['afp']} ng/mL")
              print(f"Tumor size: {params['tumor_size']} cm")
              
              # Load original config
              tree = ET.parse("config/PhysiCell_settings_original.xml")
              root = tree.getroot()
              
              # Update timing parameters
              sim_days = int("${{ github.event.inputs.simulation_days }}")
              output_hours = int("${{ github.event.inputs.output_interval }}")
              
              max_time = root.find(".//max_time")
              if max_time is not None:
                  max_time.text = str(sim_days * 1440)
              
              # Disable SVG
              svg_enable = root.find(".//SVG/enable")
              if svg_enable is not None:
                  svg_enable.text = "false"
              
              svg_interval = root.find(".//SVG/interval")
              if svg_interval is not None:
                  svg_interval.text = "999999"
              
              # Set output interval
              full_data_interval = root.find(".//full_data/interval")
              if full_data_interval is not None:
                  full_data_interval.text = str(output_hours * 60)
              
              # Update user parameters
              user_params = root.find(".//user_parameters")
              if user_params is None:
                  user_params = ET.SubElement(root, "user_parameters")
              
              # Clear existing and add new
              user_params.clear()
              
              param_defs = {
                  "HBV_DNA_copies": (params["hbv_dna"], "double", "copies/mL"),
                  "HBsAg_positive": (params["hbsag"], "int", "dimensionless"),
                  "HBeAg_positive": (params["hbeag"], "int", "dimensionless"),
                  "cirrhosis_degree": (params["cirrhosis"], "int", "grade"),
                  "inflammation_level": (params["inflammation_level"], "double", "dimensionless"),
                  "immune_suppression": (params["immune_suppression"], "double", "dimensionless"),
                  "AFP_level": (params["afp"], "double", "ng/mL"),
                  "tumor_size_cm": (params["tumor_size"], "double", "cm"),
                  "simulation_id": (sim_id, "int", "dimensionless")
              }
              
              for name, (value, ptype, units) in param_defs.items():
                  elem = ET.SubElement(user_params, name)
                  elem.set("type", ptype)
                  elem.set("units", units)
                  elem.text = str(value)
              
              # Save config
              tree.write("config/PhysiCell_settings.xml")
              
              # Clean output directory
              if os.path.exists("output"):
                  shutil.rmtree("output")
              os.makedirs("output")
              
              # Run simulation
              try:
                  result = subprocess.run(
                      ["./heterogeneity"],
                      capture_output=True,
                      text=True,
                      timeout=300  # 5 min timeout
                  )
                  
                  # Check for errors
                  if result.returncode != 0:
                      print(f"✗ Simulation failed with return code {result.returncode}")
                      print(f"STDERR: {result.stderr[:500]}")
                      results.append({
                          "sim_id": sim_id,
                          "status": "failed",
                          "error": result.stderr[:200],
                          "params": params
                      })
                      continue
                  
                  # Move output
                  output_dir = f"results/sim_{sim_id:03d}"
                  os.makedirs(output_dir, exist_ok=True)
                  
                  xml_count = 0
                  if os.path.exists("output"):
                      for file in os.listdir("output"):
                          if file.endswith(".xml"):
                              shutil.copy(f"output/{file}", f"{output_dir}/{file}")
                              xml_count += 1
                  
                  if xml_count == 0:
                      print("✗ No output files generated")
                      results.append({
                          "sim_id": sim_id,
                          "status": "no_output",
                          "params": params
                      })
                  else:
                      results.append({
                          "sim_id": sim_id,
                          "status": "success",
                          "output_files": xml_count,
                          "params": params
                      })
                      print(f"✓ Completed successfully ({xml_count} output files)")
                  
              except subprocess.TimeoutExpired:
                  results.append({
                      "sim_id": sim_id,
                      "status": "timeout",
                      "params": params
                  })
                  print("✗ Timeout")
              except Exception as e:
                  results.append({
                      "sim_id": sim_id,
                      "status": "error",
                      "error": str(e),
                      "params": params
                  })
                  print(f"✗ Error: {e}")
          
          # Save results manifest
          with open("results/manifest.json", "w") as f:
              json.dump(results, f, indent=2)
          
          print(f"\n{'='*60}")
          print(f"Completed {len(results)} simulations")
          success_count = sum(1 for r in results if r["status"] == "success")
          print(f"Successful: {success_count}/{len(results)}")
          print(f"{'='*60}")
          EOF
      
      - name: Analyze results
        run: |
          python3 << 'EOF'
          import json
          import os
          import xml.etree.ElementTree as ET
          import pandas as pd
          import numpy as np
          import matplotlib.pyplot as plt
          import seaborn as sns
          
          sns.set_style("whitegrid")
          
          # Load manifest
          with open("results/manifest.json") as f:
              manifest = json.load(f)
          
          # Extract metrics from each simulation
          data = []
          
          for sim in manifest:
              if sim["status"] != "success":
                  print(f"Skipping sim {sim['sim_id']}: {sim['status']}")
                  continue
              
              sim_id = sim["sim_id"]
              sim_dir = f"results/sim_{sim_id:03d}"
              
              if not os.path.exists(sim_dir):
                  print(f"Directory not found: {sim_dir}")
                  continue
              
              # Get all output files sorted by time
              xml_files = sorted([f for f in os.listdir(sim_dir) if f.endswith(".xml") and "initial" not in f])
              
              if len(xml_files) < 2:
                  print(f"Not enough timepoints for sim {sim_id}: {len(xml_files)}")
                  continue
              
              # Parse first and last timepoints
              first_file = f"{sim_dir}/{xml_files[0]}"
              last_file = f"{sim_dir}/{xml_files[-1]}"
              
              def count_cells(xml_path):
                  try:
                      tree = ET.parse(xml_path)
                      root = tree.getroot()
                      cells = root.findall(".//cell")
                      return len(cells)
                  except:
                      return 0
              
              try:
                  n_start = count_cells(first_file)
                  n_end = count_cells(last_file)
                  
                  if n_start == 0:
                      print(f"No cells in initial state for sim {sim_id}")
                      continue
                  
                  fold_change = n_end / n_start if n_start > 0 else 0
                  sim_days = int("${{ github.event.inputs.simulation_days }}")
                  
                  if fold_change > 1:
                      doubling_time = sim_days / np.log2(fold_change)
                  else:
                      doubling_time = np.inf
                  
                  # Growth rate (exponential)
                  growth_rate = np.log(max(n_end / n_start, 0.001)) / sim_days
                  
                  # Aggregate data
                  data.append({
                      "sim_id": sim_id,
                      "hbv_dna": sim["params"]["hbv_dna"],
                      "hbv_dna_log": np.log10(sim["params"]["hbv_dna"] + 1),
                      "cirrhosis": sim["params"]["cirrhosis"],
                      "afp": sim["params"]["afp"],
                      "tumor_size": sim["params"]["tumor_size"],
                      "inflammation": sim["params"]["inflammation_level"],
                      "immune_suppression": sim["params"]["immune_suppression"],
                      "cells_start": n_start,
                      "cells_end": n_end,
                      "fold_change": fold_change,
                      "doubling_time_days": doubling_time,
                      "growth_rate": growth_rate,
                      "timepoints": len(xml_files),
                      "risk_score": growth_rate * sim["params"]["inflammation_level"] * (1 + sim["params"]["cirrhosis"]/3)
                  })
                  
                  print(f"✓ Sim {sim_id}: {n_start} → {n_end} cells (fold change: {fold_change:.2f})")
              
              except Exception as e:
                  print(f"Error parsing sim {sim_id}: {e}")
                  continue
          
          if not data:
              print("ERROR: No valid simulation data")
              exit(1)
          
          df = pd.DataFrame(data)
          df.to_csv("results/simulation_metrics.csv", index=False)
          
          print("\n" + "="*80)
          print("SIMULATION SUMMARY")
          print("="*80)
          print(df.describe())
          
          print("\n" + "="*80)
          print("KEY FINDINGS")
          print("="*80)
          
          # Analysis continues as before...
          print("\n✓ Results saved to results/simulation_metrics.csv")
          
          # Generate simple plot
          fig, axes = plt.subplots(1, 2, figsize=(12, 5))
          
          ax = axes[0]
          ax.scatter(df['hbv_dna_log'], df['growth_rate'], s=100, alpha=0.7)
          ax.set_xlabel('HBV DNA (log10)')
          ax.set_ylabel('Growth Rate')
          ax.set_title('HBV vs Growth Rate')
          
          ax = axes[1]
          ax.bar(range(len(df)), df['fold_change'])
          ax.set_xlabel('Simulation')
          ax.set_ylabel('Fold Change')
          ax.set_title('Tumor Expansion')
          
          plt.tight_layout()
          plt.savefig('results/quick_analysis.png', dpi=150)
          print("✓ Plot saved to results/quick_analysis.png")
          EOF
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: hbv-hcc-${{ github.event.inputs.patient_cohort }}
          path: results/
          retention-days: 90
      
      - name: Summary
        if: always()
        run: |
          echo "## Simulation Complete" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results/simulation_metrics.csv ]; then
            echo "✅ Results available for download" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No results generated - check logs" >> $GITHUB_STEP_SUMMARY
          fi
