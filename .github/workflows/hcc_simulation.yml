name: HBV-HCC Analysis

on:
  workflow_dispatch:
    inputs:
      cohort:
        description: 'Analysis scope'
        type: choice
        options:
          - 'quick_test'      # 3 simulations, 5 min
          - 'full_paper'      # 12 simulations, 45 min
        default: 'quick_test'

jobs:
  simulate:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential python3-pip
          pip3 install pandas numpy matplotlib seaborn scipy
          make heterogeneity-sample
          make -j$(nproc)
      
      - name: Define scenarios
        run: |
          python3 << 'EOF'
          import json
          
          mode = "${{ github.event.inputs.cohort }}"
          
          if mode == 'quick_test':
              # Quick validation: 3 HBV levels
              scenarios = [
                  {'id': 0, 'name': 'HBV-negative', 'hbv_log': 0, 'onco': 0.6, 'radius': 250, 'cirrh': 1},
                  {'id': 1, 'name': 'HBV-medium', 'hbv_log': 5, 'onco': 1.2, 'radius': 250, 'cirrh': 2},
                  {'id': 2, 'name': 'HBV-high', 'hbv_log': 7, 'onco': 1.8, 'radius': 270, 'cirrh': 3}
              ]
              days = 7
          else:
              # Full paper: 12 scenarios (4 HBV × 3 cirrhosis)
              scenarios = []
              sim_id = 0
              for hbv_log, onco in [(0, 0.6), (3, 0.9), (5, 1.3), (7, 1.8)]:
                  for cirrh, radius in [(0, 230), (2, 250), (3, 280)]:
                      scenarios.append({
                          'id': sim_id,
                          'name': f'HBV_{hbv_log}_Cirrh_{cirrh}',
                          'hbv_log': hbv_log,
                          'onco': onco,
                          'radius': radius,
                          'cirrh': cirrh
                      })
                      sim_id += 1
              days = 14
          
          with open('scenarios.json', 'w') as f:
              json.dump({'scenarios': scenarios, 'days': days}, f, indent=2)
          
          print(f"Configured {len(scenarios)} scenarios, {days} days each")
          EOF
      
      - name: Run simulations
        run: |
          mkdir -p results
          
          python3 << 'EOF'
          import json
          import subprocess
          import os
          import xml.etree.ElementTree as ET
          import re
          
          with open('scenarios.json') as f:
              config = json.load(f)
          
          scenarios = config['scenarios']
          sim_days = config['days']
          results = []
          
          for scenario in scenarios:
              print(f"\n{'='*60}")
              print(f"[{scenario['id']+1}/{len(scenarios)}] {scenario['name']}")
              
              # Configure
              tree = ET.parse("config/PhysiCell_settings.xml")
              root = tree.getroot()
              
              root.find(".//max_time").text = str(sim_days * 1440)
              root.find(".//full_data/interval").text = "1440"
              root.find(".//SVG/enable").text = "false"
              
              user = root.find(".//user_parameters")
              user.find("oncoprotein_mean").text = str(scenario['onco'])
              user.find("tumor_radius").text = str(scenario['radius'])
              
              tree.write("config/PhysiCell_settings.xml")
              
              # Run
              subprocess.run(["rm", "-rf", "output"], check=True)
              subprocess.run(["mkdir", "output"], check=True)
              
              result = subprocess.run(
                  ["./heterogeneity"],
                  capture_output=True,
                  text=True,
                  timeout=600
              )
              
              # Extract cells
              cell_counts = []
              for line in result.stdout.split('\n'):
                  if 'total agents:' in line:
                      match = re.search(r'total agents: (\d+)', line)
                      if match:
                          cell_counts.append(int(match.group(1)))
              
              if len(cell_counts) >= 2:
                  scenario['cells_start'] = cell_counts[0]
                  scenario['cells_end'] = cell_counts[-1]
                  scenario['trajectory'] = cell_counts
                  results.append(scenario)
                  print(f"✓ {cell_counts[0]} → {cell_counts[-1]}")
              else:
                  print(f"✗ Failed")
          
          with open('results/data.json', 'w') as f:
              json.dump({'results': results, 'days': sim_days}, f, indent=2)
          
          print(f"\n✓ Completed {len(results)}/{len(scenarios)}")
          EOF
      
      - name: Analyze
        run: |
          python3 << 'EOF'
          import json
          import pandas as pd
          import numpy as np
          import matplotlib.pyplot as plt
          import seaborn as sns
          from scipy import stats
          
          sns.set_style("whitegrid")
          
          with open('results/data.json') as f:
              data = json.load(f)
          
          results = data['results']
          sim_days = data['days']
          
          # Calculate metrics
          for r in results:
              r['net_growth'] = r['cells_end'] - r['cells_start']
              r['percent_growth'] = 100 * r['net_growth'] / r['cells_start']
              r['fold_change'] = r['cells_end'] / r['cells_start']
              r['growth_rate'] = np.log(r['fold_change']) / sim_days
              r['doubling_time'] = np.log(2) / r['growth_rate'] if r['growth_rate'] > 0 else np.inf
          
          df = pd.DataFrame(results)
          df.to_csv('results/metrics.csv', index=False)
          
          print("\n" + "="*70)
          print("RESULTS")
          print("="*70)
          print(df[['name', 'hbv_log', 'cirrh', 'cells_start', 'cells_end', 'percent_growth']].to_string(index=False))
          
          # Only do stats if we have multiple simulations
          if len(df) >= 3:
              print("\n" + "="*70)
              print("STATISTICAL ANALYSIS")
              print("="*70)
              
              # Group by HBV level
              hbv_groups = df.groupby('hbv_log').agg({
                  'growth_rate': ['mean', 'std', 'count'],
                  'percent_growth': 'mean'
              }).round(4)
              print("\nBy HBV viral load:")
              print(hbv_groups)
              
              # If multiple HBV levels, do ANOVA
              unique_hbv = df['hbv_log'].unique()
              if len(unique_hbv) >= 3:
                  groups = [df[df['hbv_log'] == level]['growth_rate'].values for level in unique_hbv]
                  f_stat, p_value = stats.f_oneway(*groups)
                  print(f"\nANOVA: F={f_stat:.3f}, p={p_value:.4f} {'***' if p_value < 0.001 else '**' if p_value < 0.01 else '*' if p_value < 0.05 else 'ns'}")
              
              # Correlation
              if df['hbv_log'].nunique() > 1:
                  corr = df[['hbv_log', 'growth_rate']].corr().iloc[0, 1]
                  print(f"\nHBV-Growth correlation: r = {corr:.3f}")
          
          # Plotting
          n_sims = len(df)
          
          if n_sims == 1:
              # Single simulation: show trajectory
              fig, ax = plt.subplots(figsize=(10, 6))
              days = np.linspace(0, sim_days, len(df.iloc[0]['trajectory']))
              ax.plot(days, df.iloc[0]['trajectory'], 'o-', linewidth=3, markersize=8, color='steelblue')
              ax.set_xlabel('Days', fontsize=14, fontweight='bold')
              ax.set_ylabel('Cell Count', fontsize=14, fontweight='bold')
              ax.set_title(f"Tumor Growth: {df.iloc[0]['name']}", fontsize=16, fontweight='bold')
              ax.grid(alpha=0.3)
              
          elif n_sims <= 3:
              # Few simulations: trajectories + bar chart
              fig, axes = plt.subplots(1, 2, figsize=(14, 5))
              
              # Trajectories
              for _, row in df.iterrows():
                  days = np.linspace(0, sim_days, len(row['trajectory']))
                  axes[0].plot(days, row['trajectory'], 'o-', linewidth=2, label=row['name'], markersize=6)
              axes[0].set_xlabel('Days', fontsize=12, fontweight='bold')
              axes[0].set_ylabel('Cell Count', fontsize=12, fontweight='bold')
              axes[0].set_title('Tumor Growth Trajectories', fontsize=14, fontweight='bold')
              axes[0].legend()
              axes[0].grid(alpha=0.3)
              
              # Bar chart
              colors = ['green', 'orange', 'red'][:n_sims]
              axes[1].bar(df['name'], df['percent_growth'], color=colors, alpha=0.7, edgecolor='black', linewidth=2)
              axes[1].set_ylabel('Percent Growth (%)', fontsize=12, fontweight='bold')
              axes[1].set_title('Final Growth Comparison', fontsize=14, fontweight='bold')
              axes[1].grid(alpha=0.3, axis='y')
              plt.xticks(rotation=15, ha='right')
              
          else:
              # Many simulations: comprehensive analysis
              fig, axes = plt.subplots(2, 2, figsize=(14, 10))
              
              # HBV dose-response
              axes[0, 0].scatter(df['hbv_log'], df['growth_rate'], s=150, c=df['cirrh'], 
                                cmap='YlOrRd', alpha=0.7, edgecolors='black', linewidths=2)
              axes[0, 0].set_xlabel('HBV DNA (log10)', fontsize=11, fontweight='bold')
              axes[0, 0].set_ylabel('Growth Rate (day⁻¹)', fontsize=11, fontweight='bold')
              axes[0, 0].set_title('HBV Effect', fontsize=13, fontweight='bold')
              axes[0, 0].grid(alpha=0.3)
              
              # Trajectories
              for _, row in df.iterrows():
                  days = np.linspace(0, sim_days, len(row['trajectory']))
                  color = plt.cm.Reds(row['hbv_log'] / 7)
                  axes[0, 1].plot(days, row['trajectory'], alpha=0.6, linewidth=2, color=color)
              axes[0, 1].set_xlabel('Days', fontsize=11, fontweight='bold')
              axes[0, 1].set_ylabel('Cell Count', fontsize=11, fontweight='bold')
              axes[0, 1].set_title('Growth Trajectories', fontsize=13, fontweight='bold')
              axes[0, 1].grid(alpha=0.3)
              
              # Percent growth by scenario
              axes[1, 0].bar(range(len(df)), df['percent_growth'], 
                            color=plt.cm.Reds(df['hbv_log'] / 7), alpha=0.7, edgecolor='black')
              axes[1, 0].set_xlabel('Scenario', fontsize=11, fontweight='bold')
              axes[1, 0].set_ylabel('Percent Growth (%)', fontsize=11, fontweight='bold')
              axes[1, 0].set_title('Growth by Scenario', fontsize=13, fontweight='bold')
              axes[1, 0].grid(alpha=0.3, axis='y')
              
              # Summary stats
              axes[1, 1].axis('off')
              summary = f"""
              SUMMARY
              {'='*30}
              
              Simulations: {len(df)}
              Duration: {sim_days} days
              
              Avg growth: {df['percent_growth'].mean():.1f}%
              Range: {df['percent_growth'].min():.1f}% - {df['percent_growth'].max():.1f}%
              
              Avg doubling time: {df['doubling_time'].mean():.1f} days
              """
              
              if 'corr' in locals():
                  summary += f"\nHBV correlation: {corr:.3f}"
              
              axes[1, 1].text(0.1, 0.5, summary, fontsize=11, family='monospace',
                             verticalalignment='center', bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))
          
          plt.tight_layout()
          plt.savefig('results/analysis.png', dpi=200, bbox_inches='tight')
          print("\n✓ Figure saved: results/analysis.png")
          EOF
      
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: hbv-analysis-${{ github.event.inputs.cohort }}
          path: results/
      
      - name: Summary
        run: |
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          if [ -f results/metrics.csv ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat results/metrics.csv >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
