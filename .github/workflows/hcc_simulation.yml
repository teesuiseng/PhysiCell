name: HCC KHK Simulation

on:
  workflow_dispatch:
    inputs:
      khk_level:
        description: 'KHK expression level (11-20)'
        required: true
        default: '17.0'
        type: string
      simulation_time:
        description: 'Simulation time (minutes)'
        required: true
        default: '360'
        type: string
      patient_id:
        description: 'Patient ID'
        required: false
        default: 'test'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libxml2-dev zlib1g-dev
      
      - name: Verify custom files
        run: |
          echo "=== Custom modules ==="
          ls -la custom_modules/
          if [ ! -f custom_modules/custom.cpp ] || [ ! -f custom_modules/custom.h ]; then
            echo "ERROR: Custom files missing!"
            exit 1
          fi
          echo "✓ Custom files found"
      
      - name: Update config
        run: |
          sed -i "s/<KHK_expression.*<\/KHK_expression>/<KHK_expression type=\"double\" units=\"dimensionless\">${{ github.event.inputs.khk_level }}<\/KHK_expression>/" config/PhysiCell_settings.xml
          sed -i "s/<max_time.*<\/max_time>/<max_time units=\"min\">${{ github.event.inputs.simulation_time }}<\/max_time>/" config/PhysiCell_settings.xml
          echo "=== Config updated ==="
          grep -A2 "user_parameters" config/PhysiCell_settings.xml
      
      - name: Compile
        run: |
          make clean
          make
          echo "=== Compilation complete ==="
          ls -lh heterogeneity
      
      - name: Run simulation
        run: |
          echo "=== Starting HCC-KHK simulation ==="
          echo "KHK level: ${{ github.event.inputs.khk_level }}"
          echo "Duration: ${{ github.event.inputs.simulation_time }} min"
          ./heterogeneity
      
      - name: Check output
        run: |
          if [ ! -d output ]; then
            echo "ERROR: No output directory!"
            exit 1
          fi
          
          XML_COUNT=$(ls output/*.xml 2>/dev/null | wc -l)
          SVG_COUNT=$(ls output/*.svg 2>/dev/null | wc -l)
          
          echo "=== Results ==="
          echo "XML files: $XML_COUNT"
          echo "SVG files: $SVG_COUNT"
          
          if [ $XML_COUNT -eq 0 ]; then
            echo "ERROR: No output generated!"
            ls -la output/
            exit 1
          fi
          
          echo "✓ Simulation completed successfully"
      
      - name: Create summary
        run: |
          cat > summary.md << EOF
          # HCC KHK Simulation Results
          
          **Patient ID:** ${{ github.event.inputs.patient_id }}
          **KHK Expression:** ${{ github.event.inputs.khk_level }}
          **Simulation Time:** ${{ github.event.inputs.simulation_time }} minutes
          
          ---
          
          ## Output Files
          
          \`\`\`
          $(ls -lh output/)
          \`\`\`
          
          ## File Counts
          - XML data files: $(ls output/*.xml 2>/dev/null | wc -l)
          - SVG visualizations: $(ls output/*.svg 2>/dev/null | wc -l)
          
          ## How to View Results
          1. Download and extract this artifact
          2. Open any \`snapshot*.svg\` file in a web browser
          3. Cell colors indicate KHK expression level:
             - **Blue**: Low KHK (<16)
             - **Yellow**: Medium KHK (16-18)  
             - **Red**: High KHK (>18)
          
          ## Timepoints
          - One snapshot per hour of simulation
          - Final timepoint: snapshot$(printf '%08d' $(($(ls output/*.xml 2>/dev/null | wc -l) - 1))).svg
          EOF
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: hcc-khk${{ github.event.inputs.khk_level }}-${{ github.event.inputs.patient_id }}
          path: |
            output/
            summary.md
          retention-days: 30
