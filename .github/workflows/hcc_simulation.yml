name: HCC HBV Recurrence Simulation

on:
  workflow_dispatch:
    inputs:
      patient_cohort:
        description: 'Patient cohort'
        required: true
        type: choice
        options:
          - 'single_patient'
          - 'high_risk'
        default: 'single_patient'
      
      hbv_viral_load:
        description: 'HBV DNA log10'
        required: false
        default: '5.0'
        type: string
      
      cirrhosis_degree:
        description: 'Cirrhosis (0-3)'
        required: false
        default: '2'
        type: string
      
      simulation_days:
        description: 'Days'
        required: true
        default: '7'  # Reduced to 1 week for faster testing
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Hard timeout for entire job
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-pip
          pip3 install pandas numpy matplotlib seaborn
      
      - name: Setup and compile
        run: |
          make heterogeneity-sample
          make -j$(nproc)
          ls -lh heterogeneity
      
      - name: Test run (5 minutes only)
        run: |
          echo "Testing default heterogeneity model..."
          timeout 30s ./heterogeneity || echo "Test run completed/timed out"
          
          if [ -d "output" ]; then
            echo "Output directory created:"
            ls -la output/ | head -20
          else
            echo "WARNING: No output directory"
          fi
      
      - name: Backup and inspect config
        run: |
          cp config/PhysiCell_settings.xml config/PhysiCell_settings_backup.xml
          
          echo "=== Current config timing ==="
          grep -A2 "max_time" config/PhysiCell_settings.xml
          grep -A2 "interval" config/PhysiCell_settings.xml | head -10
      
      - name: Generate minimal config
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          
          # Parse existing config
          tree = ET.parse("config/PhysiCell_settings_backup.xml")
          root = tree.getroot()
          
          # CRITICAL: Set very short simulation time for testing
          sim_days = int("${{ github.event.inputs.simulation_days }}")
          
          max_time = root.find(".//max_time")
          if max_time is not None:
              max_time.text = str(sim_days * 1440)  # days to minutes
              print(f"Set max_time to {sim_days * 1440} minutes ({sim_days} days)")
          
          # Set output interval (every 12 hours for testing)
          full_interval = root.find(".//full_data/interval")
          if full_interval is not None:
              full_interval.text = "720"  # 12 hours
              print("Set output interval to 720 min (12 hours)")
          
          # Enable full data output
          full_enable = root.find(".//full_data/enable")
          if full_enable is not None:
              full_enable.text = "true"
          
          # DISABLE SVG completely
          svg_enable = root.find(".//SVG/enable")
          if svg_enable is not None:
              svg_enable.text = "false"
              print("Disabled SVG output")
          
          svg_interval = root.find(".//SVG/interval")
          if svg_interval is not None:
              svg_interval.text = "999999"
          
          # Add HBV parameters
          user_params = root.find(".//user_parameters")
          if user_params is None:
              overall = root.find(".//overall")
              if overall is not None:
                  user_params = ET.Element("user_parameters")
                  root.insert(list(root).index(overall) + 1, user_params)
              else:
                  user_params = ET.SubElement(root, "user_parameters")
          
          # Simple parameter set
          hbv_viral_load = float("${{ github.event.inputs.hbv_viral_load }}")
          cirrhosis = int("${{ github.event.inputs.cirrhosis_degree }}")
          
          params = {
              "HBV_DNA_log": hbv_viral_load,
              "cirrhosis_grade": cirrhosis,
              "inflammation": min(hbv_viral_load / 7.0, 1.0),
              "simulation_days": sim_days
          }
          
          for name, value in params.items():
              elem = user_params.find(name)
              if elem is None:
                  elem = ET.SubElement(user_params, name)
              elem.text = str(value)
              elem.set("type", "double")
              print(f"Set {name} = {value}")
          
          tree.write("config/PhysiCell_settings.xml")
          print("\n✓ Config updated")
          EOF
      
      - name: Verify config changes
        run: |
          echo "=== Updated config ==="
          grep "max_time" config/PhysiCell_settings.xml
          grep -A5 "user_parameters" config/PhysiCell_settings.xml || echo "No user_parameters section"
      
      - name: Run simulation with monitoring
        run: |
          mkdir -p results/sim_000
          
          echo "Starting simulation..."
          echo "Start time: $(date)"
          
          # Run with timeout and capture output
          timeout 360s ./heterogeneity > results/simulation.log 2>&1 &
          SIM_PID=$!
          
          # Monitor progress
          for i in {1..60}; do
            sleep 5
            
            if ! kill -0 $SIM_PID 2>/dev/null; then
              echo "Simulation completed at iteration $i"
              break
            fi
            
            if [ -d "output" ]; then
              XML_COUNT=$(ls output/*.xml 2>/dev/null | wc -l)
              echo "[$i/60] Running... ($XML_COUNT XML files so far)"
            else
              echo "[$i/60] Running... (no output yet)"
            fi
            
            # Check if process is actually doing work
            if [ $i -eq 12 ]; then
              echo "=== 60-second checkpoint ==="
              if [ ! -d "output" ] || [ $(ls output/*.xml 2>/dev/null | wc -l) -eq 0 ]; then
                echo "WARNING: No output after 60 seconds - may be stuck"
                tail -20 results/simulation.log
              fi
            fi
          done
          
          wait $SIM_PID || echo "Process ended with code $?"
          
          echo "End time: $(date)"
          
          # Copy outputs
          if [ -d "output" ]; then
            cp output/*.xml results/sim_000/ 2>/dev/null || true
            echo "=== Final output ==="
            ls -lh results/sim_000/ | head -20
          fi
          
          # Show simulation log
          echo "=== Simulation log (last 50 lines) ==="
          tail -50 results/simulation.log
      
      - name: Quick analysis
        run: |
          python3 << 'EOF'
          import os
          import xml.etree.ElementTree as ET
          
          sim_dir = "results/sim_000"
          
          if not os.path.exists(sim_dir):
              print("ERROR: No simulation directory")
              exit(1)
          
          xml_files = sorted([f for f in os.listdir(sim_dir) if f.endswith(".xml")])
          
          if len(xml_files) == 0:
              print("ERROR: No XML output files")
              print("\nSimulation log:")
              with open("results/simulation.log") as f:
                  print(f.read()[-1000:])
              exit(1)
          
          print(f"Found {len(xml_files)} output files")
          
          # Count cells over time
          timepoints = []
          for xml_file in xml_files[:10]:  # First 10 timepoints
              try:
                  tree = ET.parse(f"{sim_dir}/{xml_file}")
                  cell_count = len(tree.findall(".//cell"))
                  timepoints.append({
                      "file": xml_file,
                      "cells": cell_count
                  })
                  print(f"{xml_file}: {cell_count} cells")
              except Exception as e:
                  print(f"Error parsing {xml_file}: {e}")
          
          if timepoints:
              first = timepoints[0]["cells"]
              last = timepoints[-1]["cells"]
              print(f"\n✓ Cell count: {first} → {last} (fold change: {last/first:.2f}x)")
          else:
              print("ERROR: Could not parse any files")
              exit(1)
          EOF
      
      - name: Upload all outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-output-${{ github.run_number }}
          path: |
            results/
            config/PhysiCell_settings.xml
            output/
          retention-days: 7
      
      - name: Summary
        if: always()
        run: |
          echo "## Debug Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results/simulation.log ]; then
            echo "### Simulation Log (last 30 lines):" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -30 results/simulation.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d results/sim_000 ]; then
            XML_COUNT=$(ls results/sim_000/*.xml 2>/dev/null | wc -l)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Output files:** $XML_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
