name: HCC KHK Simulation

on:
  workflow_dispatch:
    inputs:
      khk_level:
        description: 'KHK expression level (11-20)'
        required: true
        default: '17.0'
        type: string
      simulation_time:
        description: 'Simulation time (minutes)'
        required: true
        default: '360'
        type: string
      patient_id:
        description: 'Patient ID'
        required: false
        default: 'test'
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libxml2-dev zlib1g-dev
      
      - name: Verify custom files exist
        run: |
          echo "=== Checking custom modules ==="
          ls -la custom_modules/
          if [ ! -f custom_modules/custom.cpp ]; then
            echo "ERROR: custom.cpp not found!"
            exit 1
          fi
          if [ ! -f custom_modules/custom.h ]; then
            echo "ERROR: custom.h not found!"
            exit 1
          fi
          echo "✓ Custom files verified"
      
      - name: Update config with parameters
        run: |
          sed -i "s/<KHK_expression.*<\/KHK_expression>/<KHK_expression type=\"double\" units=\"dimensionless\">${{ github.event.inputs.khk_level }}<\/KHK_expression>/" config/PhysiCell_settings.xml
          sed -i "s/<max_time.*<\/max_time>/<max_time units=\"min\">${{ github.event.inputs.simulation_time }}<\/max_time>/" config/PhysiCell_settings.xml
          echo "=== Updated Configuration ==="
          cat config/PhysiCell_settings.xml | grep -A2 "user_parameters"
      
      - name: Compile PhysiCell with custom modules
        run: |
          echo "=== Setting up custom project ==="
          # Link main.cpp to use custom modules
          cp main.cpp main-backup.cpp
          
          echo "=== Cleaning previous build ==="
          make clean
          
          echo ""
          echo "=== Compiling with custom modules ==="
          # Compile custom modules explicitly
          make PhysiCell_custom.o
          
          # Build the full project
          make
          
          echo ""
          echo "=== Checking compilation results ==="
          ls -lh | grep -E "^-rwx" || echo "No executables found yet"
          
          # If still no executable, try explicit linking
          if [ ! -f project ] && [ ! -f myproj ] && [ ! -f heterogeneity ]; then
            echo "Attempting manual linking..."
            g++ -std=c++11 -O3 -fomit-frame-pointer -fopenmp -m64 -o project \
              main.cpp \
              PhysiCell_*.o BioFVM_*.o pugixml.o custom.o \
              -lz -lgomp
          fi
          
          echo ""
          echo "=== Final executable check ==="
          ls -lh | grep -E "^-rwx"
      
      - name: Run simulation
        run: |
          # Try different executable names
          if [ -f ./project ]; then
            EXEC=./project
            echo "Using: project"
          elif [ -f ./heterogeneity ]; then
            EXEC=./heterogeneity
            echo "Using: heterogeneity (will work with custom code)"
          elif [ -f ./myproj ]; then
            EXEC=./myproj
            echo "Using: myproj"
          else
            echo "ERROR: No executable found!"
            echo "Available files:"
            ls -lh | grep -E "^-rwx"
            exit 1
          fi
          
          echo "Running simulation with: $EXEC"
          $EXEC
      
      - name: Verify output generated
        run: |
          if [ ! -d output ]; then
            echo "ERROR: Output directory not created!"
            exit 1
          fi
          
          echo "=== Simulation output ==="
          ls -lh output/
          
          XML_COUNT=$(ls output/*.xml 2>/dev/null | wc -l)
          SVG_COUNT=$(ls output/*.svg 2>/dev/null | wc -l)
          
          echo ""
          echo "✓ Generated $XML_COUNT XML files"
          echo "✓ Generated $SVG_COUNT SVG files"
          
          if [ $XML_COUNT -eq 0 ]; then
            echo "ERROR: No output files generated!"
            exit 1
          fi
      
      - name: Create summary
        run: |
          echo "# HCC KHK Simulation Results" > summary.md
          echo "" >> summary.md
          echo "**Patient ID:** ${{ github.event.inputs.patient_id }}" >> summary.md
          echo "**KHK Expression:** ${{ github.event.inputs.khk_level }}" >> summary.md
          echo "**Duration:** ${{ github.event.inputs.simulation_time }} minutes" >> summary.md
          echo "" >> summary.md
          echo "---" >> summary.md
          echo "" >> summary.md
          
          XML_COUNT=$(ls output/*.xml 2>/dev/null | wc -l)
          SVG_COUNT=$(ls output/*.svg 2>/dev/null | wc -l)
          
          echo "## Output Summary" >> summary.md
          echo "- **XML files:** $XML_COUNT" >> summary.md
          echo "- **SVG files:** $SVG_COUNT" >> summary.md
          echo "" >> summary.md
          
          echo "## Files Generated" >> summary.md
          echo "\`\`\`" >> summary.md
          ls -lh output/ | tail -20 >> summary.md
          echo "\`\`\`" >> summary.md
          echo "" >> summary.md
          
          echo "## How to View" >> summary.md
          echo "1. Download and extract this artifact" >> summary.md
          echo "2. Open \`snapshot*.svg\` files in a web browser" >> summary.md
          echo "3. Cells are colored by KHK level:" >> summary.md
          echo "   - **Blue**: Low KHK (<16)" >> summary.md
          echo "   - **Yellow**: Medium KHK (16-18)" >> summary.md
          echo "   - **Red**: High KHK (>18)" >> summary.md
          
          echo "" >> summary.md
          echo "Last snapshot: \`snapshot$(printf '%08d' $((XML_COUNT - 1))).svg\`" >> summary.md
      
      - name: Upload simulation results
        uses: actions/upload-artifact@v4
        with:
          name: simulation-khk${{ github.event.inputs.khk_level }}-patient${{ github.event.inputs.patient_id }}
          path: |
            output/
            summary.md
          retention-days: 30
