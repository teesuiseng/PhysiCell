name: HCC HBV Recurrence Simulation

on:
  workflow_dispatch:
    inputs:
      simulation_days:
        description: 'Days to simulate'
        required: true
        default: '3'  # Very short for testing
        type: string
      
      tumor_radius:
        description: 'Tumor radius (microns)'
        required: true
        default: '150'  # Smaller = fewer cells = faster
        type: string

jobs:
  simulate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-pip
          pip3 install pandas numpy matplotlib seaborn
      
      - name: Setup and compile
        run: |
          make heterogeneity-sample
          make -j$(nproc)
      
      - name: Inspect default config
        run: |
          echo "=== Default timing parameters ==="
          grep -A1 "dt_diffusion\|dt_mechanics\|dt_phenotype" config/PhysiCell_settings.xml
          echo ""
          echo "=== Default max_time ==="
          grep "max_time" config/PhysiCell_settings.xml
          echo ""
          echo "=== Cell parameters ==="
          grep -A2 "tumor_radius\|number_of_cells" config/PhysiCell_settings.xml
      
      - name: Create optimized config
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          
          tree = ET.parse("config/PhysiCell_settings.xml")
          root = tree.getroot()
          
          # TIMING - Make simulation faster
          sim_days = int("${{ github.event.inputs.simulation_days }}")
          
          max_time = root.find(".//max_time")
          if max_time is not None:
              max_time.text = str(sim_days * 1440)
              print(f"âœ“ Max time: {sim_days} days ({sim_days * 1440} min)")
          
          # INCREASE timesteps to speed up simulation
          dt_mechanics = root.find(".//dt_mechanics")
          if dt_mechanics is not None:
              dt_mechanics.text = "0.5"  # Increased from 0.1
              print("âœ“ Mechanics timestep: 0.5 min (5x faster)")
          
          dt_phenotype = root.find(".//dt_phenotype")
          if dt_phenotype is not None:
              dt_phenotype.text = "12"  # Increased from 6
              print("âœ“ Phenotype timestep: 12 min (2x faster)")
          
          # OUTPUT - Less frequent saves
          full_interval = root.find(".//full_data/interval")
          if full_interval is not None:
              full_interval.text = "1440"  # Once per day
              print("âœ“ Output interval: 1 day")
          
          # Disable SVG
          svg_enable = root.find(".//SVG/enable")
          if svg_enable is not None:
              svg_enable.text = "false"
              print("âœ“ SVG disabled")
          
          # CELL INITIALIZATION - Smaller tumor
          user_params = root.find(".//user_parameters")
          
          tumor_radius = user_params.find("tumor_radius")
          if tumor_radius is not None:
              radius = int("${{ github.event.inputs.tumor_radius }}")
              tumor_radius.text = str(radius)
              # Estimate cells: sphere volume / cell volume
              # Cell diameter ~20Î¼m, so volume ~4000 Î¼mÂ³
              estimated_cells = int((4/3) * 3.14159 * (radius**3) / 4000)
              print(f"âœ“ Tumor radius: {radius}Î¼m (~{estimated_cells} cells)")
          
          # Set number_of_cells to 0 (use radius)
          num_cells = user_params.find("number_of_cells")
          if num_cells is not None:
              num_cells.text = "0"
          
          # DISABLE SOME FEATURES for speed
          # Turn off fluid flow
          microenv = root.find(".//microenvironment_setup")
          if microenv is not None:
              for var in microenv.findall(".//variable"):
                  diff_coef = var.find("diffusion_coefficient")
                  if diff_coef is not None:
                      diff_coef.text = "0"  # No diffusion = faster
          
          tree.write("config/PhysiCell_settings.xml")
          print("\nâœ“ Optimized config saved")
          EOF
      
      - name: Verify config
        run: |
          echo "=== Updated config ==="
          grep "max_time\|dt_mechanics\|dt_phenotype\|tumor_radius" config/PhysiCell_settings.xml | head -10
      
      - name: Run simulation with live monitoring
        run: |
          mkdir -p output
          
          echo "Starting simulation..."
          echo "Expect ~$(($(echo "${{ github.event.inputs.tumor_radius }}" | awk '{print int((4/3) * 3.14159 * ($1**3) / 4000)}') )) cells"
          
          # Run in background
          ./heterogeneity > simulation.log 2>&1 &
          SIM_PID=$!
          
          # Monitor with shorter intervals
          for i in {1..120}; do
            sleep 5
            
            # Check if still running
            if ! kill -0 $SIM_PID 2>/dev/null; then
              echo "âœ“ Simulation completed at $((i * 5)) seconds"
              break
            fi
            
            # Count outputs
            if [ -d "output" ]; then
              XML_COUNT=$(ls output/output*.xml 2>/dev/null | wc -l)
              echo "[${i}] Running... ($XML_COUNT timepoints saved)"
            else
              echo "[${i}] Running... (no output yet)"
            fi
            
            # Show progress from log
            if [ $((i % 6)) -eq 0 ]; then
              echo "--- Progress check (${i}0 sec) ---"
              tail -3 simulation.log | grep "current simulated time" || echo "(no time update yet)"
            fi
            
            # Emergency timeout
            if [ $i -eq 120 ]; then
              echo "âš  Reached 10-minute limit, stopping..."
              kill $SIM_PID 2>/dev/null || true
              break
            fi
          done
          
          wait $SIM_PID || echo "Process exited with code $?"
          
          echo ""
          echo "=== Simulation complete ==="
          echo "Output files:"
          ls -lh output/*.xml 2>/dev/null | wc -l
          
          echo ""
          echo "=== Last 30 lines of log ==="
          tail -30 simulation.log
      
      - name: Analyze output
        run: |
          python3 << 'EOF'
          import os
          import xml.etree.ElementTree as ET
          import pandas as pd
          import numpy as np
          
          if not os.path.exists("output"):
              print("ERROR: No output directory")
              exit(1)
          
          xml_files = sorted([f for f in os.listdir("output") if f.startswith("output") and f.endswith(".xml")])
          
          if len(xml_files) == 0:
              print("ERROR: No output files generated")
              
              # Show what went wrong
              if os.path.exists("simulation.log"):
                  with open("simulation.log") as f:
                      log_lines = f.readlines()
                      print("\n=== First 20 lines of log ===")
                      for line in log_lines[:20]:
                          print(line.rstrip())
                      print("\n=== Last 20 lines of log ===")
                      for line in log_lines[-20:]:
                          print(line.rstrip())
              exit(1)
          
          print(f"âœ“ Found {len(xml_files)} output files")
          
          # Extract cell counts
          timepoints = []
          for xml_file in xml_files:
              try:
                  tree = ET.parse(f"output/{xml_file}")
                  cells = tree.findall(".//cell")
                  cell_count = len(cells)
                  
                  # Extract time
                  time_elem = tree.find(".//current_time")
                  time = float(time_elem.text) if time_elem is not None else 0
                  
                  timepoints.append({
                      "file": xml_file,
                      "time_min": time,
                      "time_days": time / 1440.0,
                      "cells": cell_count
                  })
              except Exception as e:
                  print(f"Error parsing {xml_file}: {e}")
          
          if not timepoints:
              print("ERROR: Could not parse any files")
              exit(1)
          
          df = pd.DataFrame(timepoints)
          df.to_csv("results.csv", index=False)
          
          print("\n" + "="*70)
          print("SIMULATION RESULTS")
          print("="*70)
          print(df.to_string(index=False))
          
          print("\n" + "="*70)
          print("SUMMARY")
          print("="*70)
          
          initial_cells = df.iloc[0]["cells"]
          final_cells = df.iloc[-1]["cells"]
          fold_change = final_cells / initial_cells if initial_cells > 0 else 0
          sim_days = df.iloc[-1]["time_days"]
          
          if fold_change > 0 and fold_change != 1:
              growth_rate = np.log(fold_change) / sim_days
              doubling_time = np.log(2) / growth_rate if growth_rate > 0 else np.inf
              
              print(f"Initial cells:     {initial_cells}")
              print(f"Final cells:       {final_cells}")
              print(f"Fold change:       {fold_change:.2f}x")
              print(f"Growth rate:       {growth_rate:.4f} dayâ»Â¹")
              print(f"Doubling time:     {doubling_time:.1f} days")
          else:
              print(f"Initial cells:     {initial_cells}")
              print(f"Final cells:       {final_cells}")
              print("(No growth detected)")
          
          print("\nâœ“ Results saved to results.csv")
          EOF
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simulation-output
          path: |
            output/
            simulation.log
            results.csv
            config/PhysiCell_settings.xml
          retention-days: 7
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”¬ Simulation Results" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results.csv ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Simulation completed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat results.csv >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Simulation did not complete**" >> $GITHUB_STEP_SUMMARY
            
            if [ -f simulation.log ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Last lines of log:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              tail -20 simulation.log >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi
